<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRIMED CERTIFICATE VERIFIER</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<style>
body{font-family:Roboto,sans-serif;background:linear-gradient(180deg,#eef3f9,#f9fbfd);display:flex;justify-content:center;align-items:center;height:100vh;margin:0;}
.container{background:#fff;padding:26px;border-radius:14px;width:95%;max-width:480px;box-shadow:0 8px 28px rgba(0,0,0,.15);text-align:center;}
.logos{display:flex;justify-content:center;gap:14px;margin-bottom:10px;}
.logos img{width:75px}
h2{margin:10px 0;color:#0d6efd;font-size:20px;font-weight:700;text-transform:uppercase;}
select,input,button{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;}
button{background:#0d6efd;color:#fff;border:none;font-weight:600;cursor:pointer;margin-top:4px;}
#scanner{display:none;margin-top:12px;} video{width:100%;border-radius:12px;}
#result{margin-top:12px;background:#f3f6fb;padding:12px;border-radius:10px;font-size:14px;text-align:left;}
footer{font-size:12px;margin-top:14px;color:#666;}
</style>
</head>
<body>
<div class="container">

<div class="logos">
  <img src="https://raw.githubusercontent.com/PRIMED-RRM/primedrrmverifier/main/PRIMED%20Logo%201.png">
  <img src="https://raw.githubusercontent.com/PRIMED-RRM/primedrrmverifier/main/BackgroundEraser_20251102_093006990.png">
</div>

<h2>CERTIFICATE VERIFIER</h2>

<select id="trainingFilter">
  <option value="">ALL TRAININGS</option>
  <option value="STOP THE BLEED">STOP THE BLEED</option>
  <option value="STANDARD FIRST AID">STANDARD FIRST AID (SFAT)</option>
  <option value="BASIC FIRST AID">BASIC FIRST AID (BFAT)</option>
  <option value="BASIC LIFE SUPPORT">BASIC LIFE SUPPORT (BLS)</option>
  <option value="CPR">CPR</option>
  <option value="BASIC FIRE SAFETY SEMINAR">BASIC FIRE SAFETY SEMINAR</option>
  <option value="INTRODUCTION TO DRRM">INTRODUCTION TO DRRM</option>
  <option value="EARTHQUAKE PREPAREDNESS SEMINAR">EARTHQUAKE PREPAREDNESS SEMINAR</option>
</select>

<input id="certInput" placeholder="ENTER YOUR CERTIFICATE NUMBER">
<div>
  <button onclick="verifyCert()">VERIFY IT </button>
  <button onclick="toggleScanner()">SCAN QR CODE </button>
</div>

<div id="scanner">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" hidden></canvas>
</div>

<div id="result"></div>

<footer>
This verification is based solely on PRIMED records and is not government certification nor international accreditation/certification.
<br>
<br>
©<span id="year"></span> PRIMEDRRMTS & ACER-FRCI | All rights reserved.
</footer>

<script>
document.getElementById("year").innerText = new Date().getFullYear();
</script>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzhSjZI7iaDGoShqTDZ_3mK6DsH2bG0hpU1KJKnPeBpDUIBa1p-3-z6KYdMSnieIQ8/exec";
const beep = document.getElementById("beep");
const certInput = document.getElementById("certInput");
const trainingFilter = document.getElementById("trainingFilter");

/* ENTER KEY */
certInput.addEventListener("keydown", e=>{
  if(e.key==="Enter") verifyCert();
});

/* VERIFY FUNCTION */
function verifyCert(cert){
  const c = cert || certInput.value.trim();
  const filter = trainingFilter.value;
  const res = document.getElementById("result");

  if(!c){ res.innerHTML="❌ PLEASE ENTER YOUR CERTIFICATE NUMBER ❌"; return; }

  res.innerHTML="VERIFYING…";

  fetch(API_URL+"?cert="+encodeURIComponent(c))
    .then(r=>r.json())
    .then(d=>{
      if(!d.found){ beep.play(); res.innerHTML="❌ CERTIFICATE NOT VALID ❌"; return; }

      if(filter && d.training.toUpperCase() !== filter.toUpperCase()){
        beep.play();
        res.innerHTML="❌ TRAINING DOES NOT MATCH SELECTED FILTER ❌";
        return;
      }

      // Format date MM-DD-YYYY
      let formattedDate = "";
      if(d.date){
        const dt = new Date(d.date);
        formattedDate = (dt.getMonth()+1).toString().padStart(2,'0') + "-" +
                        dt.getDate().toString().padStart(2,'0') + "-" +
                        dt.getFullYear();
      }

      // Result
      res.innerHTML = `<b style="color:green">✅ CERTIFICATE VERIFIED ✅</b><br><br>
        <b>NAME:</b> ${d.name.toUpperCase()}<br>
        <b>CERTIFICATE #:</b> ${d.certificate.toUpperCase()}<br>
        <b>TRAINING:</b> ${d.training.toUpperCase()}<br>
        <b>VENUE:</b> ${d.venue.toUpperCase()}<br>
        <b>DATE:</b> ${formattedDate}`;

      beep.play();
    })
    .catch(()=>{ beep.play(); res.innerHTML="❌ SERVER ERROR ❌"; });
}

/* QR SCANNER USING JSQR */
let stream=null, scanning=false;
function toggleScanner(){
  const video = document.getElementById("video");
  const scanner = document.getElementById("scanner");

  if(scanning){
    stream.getTracks().forEach(t=>t.stop());
    scanner.style.display="none";
    scanning=false;
    return;
  }

  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
    .then(s=>{
      stream=s;
      video.srcObject=s;
      scanner.style.display="block";
      scanning=true;
      video.onloadedmetadata = ()=>{ video.play(); scanLoop(); };
    })
    .catch(()=>alert("❌ CAMERA ACCESS DENIED ❌"));
}

function scanLoop(){
  if(!scanning) return;
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  const scale = 400 / Math.max(video.videoWidth, video.videoHeight);
  canvas.width = video.videoWidth * scale;
  canvas.height = video.videoHeight * scale;

  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  const qr = jsQR(img.data, canvas.width, canvas.height);

  if(qr){
    certInput.value = qr.data;
    toggleScanner();
    verifyCert(qr.data);
    return;
  }

  requestAnimationFrame(scanLoop);
}
</script>
</body>
</html>
